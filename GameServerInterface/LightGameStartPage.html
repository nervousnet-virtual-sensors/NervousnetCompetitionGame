<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>Planetary Nervous competition - Light Sensor</title>
    <script src="libs/justgage/justgage.1.0.1.min.js"></script>
    <script src="libs/justgage/raphael.2.1.0.min.js"></script>
    <script src="libs/jquery-2.1.0.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Raleway:300' rel='stylesheet' type='text/css'>
    <link href="style.css" type="text/css" rel="stylesheet">

</head>

<body bgcolor="dodgerblue" onload="getServerDetails()">
    <div id="main">
        <h1>Planetary Nervous Competition using Light Sensors</h1>
        <div id="content">
            <h2>
            <div id="server_details">
            </div>
                </h2>
            <div id="start_container">
                <img id="start" src="images/start.png">
                <br>Start
            </div>
            <div id="gauge"></div>
            <div id="timer_container">
                <img id="timer" src="images/timer.png">
                <br> <span>60:00</span>
            </div>
            <div class="winningLabel"></div>
        </div>
    </div>
    <script>
        $("#gauge").css("width", $(window).width() * 0.6);
        $("#gauge").css("height", $(window).width() * 0.6 / 1.25);
        $("#gauge").css("top", $(window).height() * 0.5);
        $("#timer_container").css("top", $(window).height() * 0.5);
        $("#timer_container").css("right", $(window).width() * 0.085);
        $("#start_container").css("top", $(window).height() * 0.5);
        $("#start_container").css("left", $(window).width() * 0.085);

        var g = new JustGage({
            id: "gauge",
            value: "",
            valueFontColor: "dodgerblue",
            labelFontColor: "dodgerblue",
            showInnerShadow: true,
            shadowOpacity: 1,
            min: 0,
            max: 100,
            value: 50,
            title: " ",
            gaugeColor: "#00FF00",
            levelColors: ['#FF0000'],
        });
        var rem_secs = 100;
        var refresh_rate = 500;
        var timer;

        /* var address = "http://nervouscomp.hopper.pw"; */
        var address = "http://127.0.0.1";

        var reset_url = address + ":6060/";
        var data_url = address + ":7171/";
        var server_details_url = address + ":7272/";
        var end_url = address + ":9090/";

        function getServerDetails() {
            $.getJSON(server_details_url, function (data) {
                var SERVER_IP = data;

                var s = document.getElementById("server_details");
                s.innerHTML = "Server IP: " + SERVER_IP + " <br>Port: 8080";
            }).error(function () {
                var s = document.getElementById("server_details");
                s.innerHTML = "Server not running";
            });
        }

        function onStartClicked() {

            $.getJSON(reset_url, function (data) {
                g.refresh(50);
                rem_secs = data;

                console.log("reset");

                $("#start_container").css("opacity", "0.5");
                //        $("h1").css("color","initial");
                timer = setInterval(function () {
                    $.getJSON(data_url, updateBar);
                }, refresh_rate);

                document.getElementById("start_container").removeEventListener(
                    "click", onStartClicked);
            });
        }

        function updateBar(value) {

            rem_secs -= refresh_rate / 1000;
            if (rem_secs <= 0.1) {
                rem_secs = 0;
            }
            secs = Math.ceil(rem_secs);

            if (secs == 0) {
                clearInterval(timer);
                if (value < 50) {
                    //team A winning
                    $(".winningLabel").text("A won!");
                    $(".winningLabel").css("color", '#00FF00');
                } else if (value == 50) {
                    //tie
                    $(".winningLabel").text("TIE!");
                    $(".winningLabel").css("color", "#FFFFFF");
                } else {
                    //team B winning
                    $(".winningLabel").text("B won!");
                    $(".winningLabel").css("color", '#FF0000');
                }
                $("#start_container").css("opacity", "1");
                document.getElementById("start_container").addEventListener(
                    "click", onStartClicked);
                $.getJSON(end_url);
            } else {
                if (value < 50) {
                    //team A winning85A137
                    $(".winningLabel").text("A");
                    $(".winningLabel").css("color", '#00FF00');
                } else if (value == 50) {
                    //tie
                    $(".winningLabel").text("TIE");
                    $(".winningLabel").css("color", "#FFFFFF");
                } else {
                    //team B winning
                    $(".winningLabel").text("B");
                    $(".winningLabel").css("color", '#FF0000');
                }
            }
            g.refresh(value);
            var shownSecs = secs % 60;
            if (shownSecs < 600)
                $("#timer_container span").text(
                    "" + parseInt(secs / 60) + ":0" + shownSecs);
            else
                $("#timer_container span").text(
                    "" + parseInt(secs / 60) + ":" + shownSecs);
        }

        document.getElementById("start_container").addEventListener("click",
            onStartClicked);
    </script>
</body>

</html>